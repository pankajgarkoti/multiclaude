#!/bin/bash
#═══════════════════════════════════════════════════════════════════════════════
# MULTICLAUDE - Parallel Claude Development Orchestrator
#
# Launches coordinated Claude agents in tmux for parallel feature development.
# Agents communicate via file-based message passing.
#
# Install: ./install.sh
# Usage:   multiclaude <command> [options]
#═══════════════════════════════════════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

print_banner() {
    printf "${CYAN}"
    cat << "EOF"
                 _ _   _      _                 _
   _ __ ___  _  _| | |_(_) ___| | __ _ _   _  __| | ___
  | '_ ` _ \| || | | __| |/ __| |/ _` | | | |/ _` |/ _ \
  | | | | | | || | | |_| | (__| | (_| | |_| | (_| |  __/
  |_| |_| |_|\__,_|\__|_|\___|_|\__,_|\__,_|\__,_|\___|

EOF
    printf "${NC}  Parallel Claude Development Orchestrator v${VERSION}\n"
    echo ""
}

print_usage() {
    printf "${BOLD}Usage:${NC} multiclaude <command> [options]\n"
    echo ""
    printf "${BOLD}Commands:${NC}\n"
    echo "  new <name>        Create a new project with AI planning"
    echo "  run [path]        Launch multi-agent tmux session"
    echo "  attach [path]     Attach to existing agent session"
    echo "  status [path]     Show status of all agents"
    echo "  add <feature>     Add a feature to current project"
    echo "  install           Install multiclaude to /usr/local/bin"
    echo ""
    printf "${BOLD}Session Structure:${NC}\n"
    echo "  Window 0: Supervisor - Coordinates workers and QA"
    echo "  Window 1: QA         - Waits for signal, runs tests"
    echo "  Window 2+: Workers   - One per feature, implements specs"
    echo ""
    printf "${BOLD}Communication:${NC}\n"
    echo "  Agents communicate via file-based message passing:"
    echo "  - Supervisor inbox: .claude/supervisor-inbox.md"
    echo "  - QA inbox:         .claude/qa-inbox.md"
    echo "  - Worker inboxes:   worktrees/feature-*/.claude/inbox.md"
    echo "  - Worker status:    worktrees/feature-*/.claude/status.log"
    echo ""
    printf "${BOLD}Examples:${NC}\n"
    echo "  multiclaude new my-app           # Create new project"
    echo "  multiclaude run ./my-project     # Launch agent session"
    echo "  multiclaude attach ./my-project  # Attach to session"
    echo "  multiclaude status ./my-project  # Check status"
    echo ""
    printf "${BOLD}Options:${NC}\n"
    echo "  -h, --help        Show this help message"
    echo "  -v, --version     Show version"
    echo ""
}

cmd_new() {
    local name="$1"
    shift || true

    print_banner

    if [[ -z "$name" ]]; then
        printf "${YELLOW}Project name:${NC} "
        read -r name
    fi

    if [[ -z "$name" ]]; then
        printf "${RED}Error: Project name required${NC}\n"
        exit 1
    fi

    printf "${BOLD}Creating project: ${name}${NC}\n"
    echo ""

    # Run bootstrap with project name pre-filled
    "$SCRIPT_DIR/bootstrap.sh" --name "$name" "$@"
}

cmd_run() {
    local path="${1:-.}"
    shift || true

    print_banner

    # Check if path is a valid project
    if [[ ! -d "$path/specs" ]] && [[ ! -d "$path/.claude" ]]; then
        printf "${RED}Error: Not a valid project directory${NC}\n"
        echo "Run 'multiclaude new <name>' to create a project first."
        exit 1
    fi

    "$SCRIPT_DIR/loop.sh" "$path" "$@"
}

cmd_attach() {
    local path="${1:-.}"

    # Resolve absolute path
    if [[ -d "$path" ]]; then
        path="$(cd "$path" && pwd)"
    else
        printf "${RED}Error: Project path does not exist: $path${NC}\n"
        exit 1
    fi

    local project_name="$(basename "$path")"
    local session_name="claude-${project_name}"

    if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux attach -t "$session_name"
    else
        printf "${RED}Error: No tmux session found: $session_name${NC}\n"
        echo ""
        echo "Run 'multiclaude run $path' to start the agent session first."
        exit 1
    fi
}

cmd_add() {
    local feature="$1"
    shift || true

    if [[ -z "$feature" ]]; then
        printf "${RED}Error: Feature name required${NC}\n"
        echo "Usage: multiclaude add <feature-name> [--description \"...\"]"
        exit 1
    fi

    "$SCRIPT_DIR/feature.sh" "." "$feature" "$@"
}

cmd_status() {
    local path="${1:-.}"

    # Resolve absolute path
    if [[ -d "$path" ]]; then
        path="$(cd "$path" && pwd)"
    else
        printf "${RED}Error: Project path does not exist: $path${NC}\n"
        exit 1
    fi

    local project_name="$(basename "$path")"
    local session_name="claude-${project_name}"

    printf "${CYAN}═══════════════════════════════════════════════════════════════${NC}\n"
    printf "${BOLD}         Agent Status - ${project_name}${NC}\n"
    printf "${CYAN}═══════════════════════════════════════════════════════════════${NC}\n"
    echo ""

    # Check tmux session
    if tmux has-session -t "$session_name" 2>/dev/null; then
        printf "tmux session: ${GREEN}${session_name} (running)${NC}\n"

        # Show windows
        printf "\n${BOLD}Windows:${NC}\n"
        tmux list-windows -t "$session_name" 2>/dev/null | while read line; do
            printf "  $line\n"
        done
    else
        printf "tmux session: ${RED}${session_name} (not running)${NC}\n"
        echo ""
        echo "Run 'multiclaude run $path' to start the agent session."
    fi
    echo ""

    # Check communication files
    printf "${BOLD}Communication Files:${NC}\n"
    if [[ -f "$path/.claude/supervisor-inbox.md" ]]; then
        local lines=$(wc -l < "$path/.claude/supervisor-inbox.md" | tr -d ' ')
        printf "  Supervisor inbox: ${GREEN}exists${NC} ($lines lines)\n"
    else
        printf "  Supervisor inbox: ${RED}missing${NC}\n"
    fi

    if [[ -f "$path/.claude/qa-inbox.md" ]]; then
        local lines=$(wc -l < "$path/.claude/qa-inbox.md" | tr -d ' ')
        printf "  QA inbox:         ${GREEN}exists${NC} ($lines lines)\n"
    else
        printf "  QA inbox:         ${RED}missing${NC}\n"
    fi
    echo ""

    # Check for worktrees
    if [[ ! -d "$path/worktrees" ]]; then
        echo "No worktrees found. Features not yet set up."
        exit 0
    fi

    printf "${BOLD}Worker Status:${NC}\n"
    printf "%-15s %-12s %s\n" "FEATURE" "STATUS" "MESSAGE"
    echo "─────────────────────────────────────────────────────────────────"

    local total=0
    local complete=0
    local in_progress=0

    for worktree in "$path"/worktrees/feature-*; do
        if [[ -d "$worktree" ]]; then
            ((total++))
            local feature=$(basename "$worktree" | sed 's/feature-//')
            local log="$worktree/.claude/status.log"

            if [[ -f "$log" ]]; then
                local last=$(grep -E '\[(PENDING|IN_PROGRESS|BLOCKED|TESTING|COMPLETE|FAILED)\]' "$log" 2>/dev/null | tail -1)
                local status=$(echo "$last" | grep -oE '\[(PENDING|IN_PROGRESS|BLOCKED|TESTING|COMPLETE|FAILED)\]' | tr -d '[]')
                local msg=$(echo "$last" | sed 's/.*\] //' | cut -c1-35)

                case "$status" in
                    COMPLETE)    color="${GREEN}"; ((complete++)) ;;
                    IN_PROGRESS) color="${YELLOW}"; ((in_progress++)) ;;
                    TESTING)     color="${CYAN}" ;;
                    BLOCKED|FAILED) color="${RED}" ;;
                    *)           color="${NC}" ;;
                esac

                printf "%-15s ${color}%-12s${NC} %s\n" "$feature" "$status" "$msg"
            else
                printf "%-15s ${RED}%-12s${NC}\n" "$feature" "NO_LOG"
            fi
        fi
    done

    echo "─────────────────────────────────────────────────────────────────"
    printf "Total: $total | ${GREEN}Complete: $complete${NC} | ${YELLOW}In Progress: $in_progress${NC}\n"
    echo ""

    # Check for completion markers
    if [[ -f "$path/.claude/PROJECT_COMPLETE" ]]; then
        printf "${GREEN}╔════════════════════════════════════════╗${NC}\n"
        printf "${GREEN}║         PROJECT COMPLETE!              ║${NC}\n"
        printf "${GREEN}╚════════════════════════════════════════╝${NC}\n"
    elif [[ -f "$path/.claude/QA_COMPLETE" ]]; then
        printf "${GREEN}QA has passed. Awaiting final completion.${NC}\n"
    elif [[ -f "$path/.claude/QA_NEEDS_FIXES" ]]; then
        printf "${YELLOW}QA found issues. Workers should check their inboxes.${NC}\n"
    elif [[ -f "$path/.claude/ALL_MERGED" ]]; then
        printf "${CYAN}All features merged. QA should be running.${NC}\n"
    fi
    echo ""
}

cmd_install() {
    "$SCRIPT_DIR/install.sh"
}

# Parse command
case "${1:-}" in
    new|create|init)
        shift
        cmd_new "$@"
        ;;
    run|start|loop)
        shift
        cmd_run "$@"
        ;;
    attach|a)
        shift
        cmd_attach "$@"
        ;;
    add|feature)
        shift
        cmd_add "$@"
        ;;
    status|monitor|ps)
        shift
        cmd_status "$@"
        ;;
    install)
        cmd_install
        ;;
    -v|--version)
        echo "multiclaude v${VERSION}"
        ;;
    -h|--help|help|"")
        print_banner
        print_usage
        ;;
    *)
        printf "${RED}Unknown command: $1${NC}\n"
        echo ""
        print_usage
        exit 1
        ;;
esac
